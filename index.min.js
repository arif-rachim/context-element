!function(){"use strict";const t=t=>t+"Changed",e=t=>null!=t&&""!==t,a=t=>!e(t),s=(t,e)=>e.reduce((e,a)=>e||t.indexOf(a)>=0,!1),i=document.createElement("style");function n(){return t=>t.nodeType!==Node.TEXT_NODE||/\S/.test(t.textContent)}i.innerHTML=".data-element-hidden {display: none !important;}",document.head.appendChild(i);const r=["data","reducer"];class o{constructor(t,e,a,s,i,n,r){this.stateAttributeProperty=null,this.attributeStateProperty=null,this.eventStateAction=null,this.render=()=>{const t=this.activeNode,e=this.stateAttributeProperty,a=this.attributeStateProperty,s=this.dataGetter().data,i=s._state,n=this.defaultAttributeValue,r=this.assetGetter;f(t,e,s,i,r),m(t,a,i,n)},this.activeNode=t,this.dataGetter=a,this.assetGetter=e,this.updateData=s,this.bubbleChildAction=r,this.reducerGetter=i,this.activeAttributeValue=l(t,n),this.defaultAttributeValue=function(t){const e=new Map;return t.getAttributeNames().forEach(a=>{e.set(a,t.getAttribute(a))}),e}(t),this.eventStateAction=h(this.activeAttributeValue),this.stateAttributeProperty=d(this.activeAttributeValue,["watch","asset"]),this.attributeStateProperty=c(this.activeAttributeValue,"toggle"),u(t,this.eventStateAction,a,s,i,r)}}const h=t=>{const e=new Map;return t.forEach((t,a)=>{if(a.endsWith("action")){const s=a.split(".");let i="",n="";1===s.length?(i="click",n="*"):2===s.length?(i=s[0],n="*"):s.length>2&&(i=s[0],n=s[1]),e.has(i)||e.set(i,new Map),e.get(i).set(n,t)}}),e},d=(t,e)=>{const a=new Map;return t.forEach((t,s)=>{if(e.filter(t=>s.endsWith(t)).length>0){const e=s.split(".");let i="",n="",r="";1===e.length?(i="content",n="*",r=e[0]):2===e.length?(i=e[0],n="*",r=e[1]):e.length>2&&(i=e[0],n=e[1],r=e[2]),a.has(n)||a.set(n,new Map);const o=a.get(n);o.has(i)||o.set(i,new Map),o.get(i).set(r,t)}}),a},c=(t,e)=>{const a=new Map;return t.forEach((t,s)=>{if(s.endsWith(e)){const e=s.split(".");let i="",n="";if(3!==e.length)throw new Error('toggle require 3 parameters separated with dot(.) : \' eg <div class="my-div" class.disabled.toggle="disabledCss"></div>');i=e[0],n=e[1],a.has(i)||a.set(i,new Map),a.get(i).set(n,t)}}),a},l=(t,e)=>{const a=new Map;return t.getAttributeNames().filter(t=>s(t,e)).forEach(e=>{a.set(e,t.getAttribute(e)),t.removeAttribute(e)}),a},u=(t,e,s,i,n,r)=>{e.forEach((e,o)=>{o=o.startsWith("on")?o.substring("on".length,o.length):o,t.addEventListener(o,t=>{t.preventDefault(),t.stopImmediatePropagation();const o=s();let h=o.data._state;if(e.has(h)||e.has("*")){const s=n(),d=e.get(h)||e.get("*");let c=o.data;const l={type:d,event:t};if("key"in o){const t=o;c=t.data,l.data=c,l.key=t.key,l.index=t.index}a(s)?r(l):i(t=>s(t,l))}})})};function p(e,a,s,i,n){var o;if(o=e,r.indexOf(o)<0&&a.getAttribute(e)!==s&&a.setAttribute(e,s),e in a){a[e]=s,"data"===e&&(a.dataPath=n);a[t(e)]=t=>g(i,n,t)}"content"===e&&(a.innerHTML=s)}const f=(t,s,i,n,r)=>{const o=s.get(n)||s.get("*");a(o)||o.forEach((a,s)=>{const n=a.get("watch"),o=a.get("asset");let h=null;e(n)?h=b(i,n):e(o)&&(h=r(o)),p(s,t,h,i,n)})},m=(t,a,s,i)=>{a.forEach((a,n)=>{const r=[],o=i.get(n),h=a.get(s);e(o)&&r.push(o),e(h)&&r.push(h);const d=r.join(" ");t.getAttribute(n)!==d&&t.setAttribute(n,d)})};const b=(t,e)=>{if(a(t))return t;try{return new Function("data",`return data.${e};`).call(null,t)}catch(e){console.warn(t,e.message)}return null},g=(t,e,s)=>{if(!a(t))try{return new Function("data","value",`data.${e} = value;`).call(null,t,s)}catch(t){console.warn(t.message)}};class y{constructor(t,e,a,s,i,n){this.render=t=>{this.dataGetter=t,this.attributeEvaluators.forEach(t=>t.render())},this.nodes=t,this.addChildActionEventListener(n);const r=["watch","action","toggle","asset"],h=Array.from(v(r,t)),d=()=>this.dataGetter();this.attributeEvaluators=h.map(t=>new o(t,e,d,a,s,r,i))}addChildActionEventListener(t){this.nodes.forEach(e=>{e.addEventListener("childAction",e=>{if(e.defaultPrevented)return;e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault();const a=e.detail,s=this.dataGetter(),i={index:s.index,event:a.event,type:a.type,data:s.data,key:s.key};t(a,i)})})}}const v=(t,e)=>e.filter(n()).reduce((e,a)=>{if(!(a instanceof HTMLElement))return e;const i=a,n=i.getAttributeNames();for(const a of n)s(a,t)&&e.add(i);if(!s(i.tagName,["context-array".toUpperCase(),"context-element".toUpperCase()])){const a=v(t,Array.from(i.childNodes));Array.from(a).forEach(t=>e.add(t))}return e},new Set);class A extends HTMLElement{constructor(){super(),this.setData=t=>{this.contextData=t(this.contextData),this.render()},this.onMounted=t=>{this.onMountedCallback=t},this.getAsset=t=>{const a=this.assets;if(e(a)&&t in a)return a[t];const s=this.superContextElement;return e(s)?s.getAsset(t):null},this.actionToPath=t=>{const a={path:this.dataPath};return e(t.key)&&(a.key=t.key,a.index=t.index,a.data=t.data),a},this.updateDataCallback=e=>{this.setData(e);const a=t("data");a in this&&this[a].call(this,this.contextData)},this.bubbleChildAction=t=>{const e={event:t.event,type:t.type,childActions:[this.actionToPath(t)]};this.dispatchDetailEvent(e)},this.updateDataFromChild=(t,e)=>{const s=this.reducer;a(s)?(t.childActions=[this.actionToPath(e),...t.childActions],this.dispatchDetailEvent(t)):this.updateDataCallback(e=>s(e,t))},this.render=()=>{if(a(this.contextData)||a(this.template))return;if(a(this.renderer)){const t=this.template.map(t=>t.cloneNode(!0));this.renderer=new y(t,this.getAsset,this.updateDataCallback,()=>this.reducer,this.bubbleChildAction,this.updateDataFromChild)}const t=[...this.renderer.nodes].reverse();let e=document.createElement("template");this.append(e);for(const a of t)e.previousSibling!==a&&this.insertBefore(a,e),e=a;const s=this.contextData;this.renderer.render(()=>({data:s})),this.lastChild.remove()},this.initAttribute=()=>{},this.dispatchDetailEvent=t=>{const e=new CustomEvent("childAction",{detail:t,cancelable:!0,bubbles:!0});this.dispatchEvent(e)},this.populateTemplate=()=>{this.template=Array.from(this.childNodes).filter(n()),this.innerHTML=""},this.getSuperContextElement=t=>t instanceof A?t:e(t.parentNode)?this.getSuperContextElement(t.parentNode):null,this.template=null,this.renderer=null,this.reducer=null,this.contextData={},this.assets={}}get data(){return this.contextData}set data(t){this.setData(()=>t)}connectedCallback(){if(this.superContextElement=this.getSuperContextElement(this.parentNode),this.initAttribute(),a(this.template)){this.classList.add("data-element-hidden");setTimeout(()=>{this.populateTemplate(),this.classList.remove("data-element-hidden"),this.render(),e(this.onMountedCallback)&&(this.onMountedCallback(),this.onMountedCallback=null)},0)}}disconnectedCallback(){this.superContextElement=null}}customElements.define("context-array",class extends A{constructor(){super(),this.setDataKeyPicker=t=>{this.dataKeyPicker=t},this.initAttribute=()=>{this.dataKeyField=this.getAttribute("data.key")},this.render=()=>{const t=this.contextData,e=this.template,s=this.renderers;if(a(t)||a(e))return;this.removeExpiredData();let i=document.createElement("template");this.append(i);const n=t.length-1;[...t].reverse().forEach((t,a)=>{const r=this.dataKeyPicker(t);if(!s.has(r)){const t=e.map(t=>t.cloneNode(!0)),a=new y(t,this.getAsset,this.updateDataCallback,()=>this.reducer,this.bubbleChildAction,this.updateDataFromChild);s.set(r,a)}const o=s.get(r),h=[...o.nodes].reverse();for(const t of h)i.previousSibling!==t&&this.insertBefore(t,i),i=t;o.render(()=>({data:t,key:r,index:n-a}))}),this.lastChild.remove()},this.removeExpiredData=()=>{const t=this.renderers,e=this.contextData.map(t=>this.dataKeyPicker(t));Array.from(t.keys()).filter(t=>e.indexOf(t)<0).forEach(e=>{t.get(e).nodes.forEach(t=>t.remove()),t.delete(e)})};this.renderers=new Map,this.dataKeyPicker=t=>{if(a(this.dataKeyField))throw new Error("'<context-array>' requires 'data.key' attribute. data-key value should refer to the unique attribute of the data.");return t[this.dataKeyField]},this.contextData=[]}static get observedAttributes(){return["data.key"]}attributeChangedCallback(t,e,a){"data.key"===t&&(this.dataKeyField=a)}}),customElements.define("context-element",A)}();
