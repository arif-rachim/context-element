!function(){"use strict";const t=t=>t+"Changed",e=t=>null!=t&&""!==t,a=t=>!e(t),r=(t,e)=>e.reduce((e,a)=>e||t.indexOf(a)>=0,!1),s=document.createElement("style");function i(){return t=>t.nodeType!==Node.TEXT_NODE||/\S/.test(t.textContent)}s.innerHTML=".data-element-hidden {display: none !important;}",document.head.appendChild(s);const n=["data","reducer"];class o{constructor(t,e,a,r){this.stateAttributeProperty=null,this.attributeStateProperty=null,this.eventStateAction=null,this.render=()=>{const t=this.activeNode,e=this.stateAttributeProperty,a=this.attributeStateProperty,r=this.dataGetter(),s=r.data._state,i=this.defaultAttributeValue;p(t,e,r,s),f(t,a,s,i)},this.activeNode=t,this.dataGetter=e,this.updateData=a,this.reducer=r,this.activeAttributeValue=l(t),this.defaultAttributeValue=function(t){const e=new Map;return t.getAttributeNames().forEach(a=>{e.set(a,t.getAttribute(a))}),e}(t),this.eventStateAction=h(this.activeAttributeValue),this.stateAttributeProperty=d(this.activeAttributeValue),this.attributeStateProperty=c(this.activeAttributeValue),u(t,this.eventStateAction,e,a,r)}}const h=t=>{const e=new Map;return t.forEach((t,a)=>{if(a.endsWith("action")){const r=a.split(".");let s="",i="";1===r.length?(s="click",i="*"):2===r.length?(s=r[0],i="*"):r.length>2&&(s=r[0],i=r[1]),e.has(s)||e.set(s,new Map),e.get(s).set(i,t)}}),e},d=t=>{const e=new Map;return t.forEach((t,a)=>{if(a.endsWith("watch")){const r=a.split(".");let s="",i="";1===r.length?(s="content",i="*"):2===r.length?(s=r[0],i="*"):r.length>2&&(s=r[0],i=r[1]),e.has(i)||e.set(i,new Map),e.get(i).set(s,t)}}),e},c=t=>{const e=new Map;return t.forEach((t,a)=>{if(a.endsWith("toggle")){const r=a.split(".");let s="",i="";if(3!==r.length)throw new Error('toggle require 3 parameters separated with dot(.) : \' eg <div class="my-div" class.disabled.toggle="disabledCss"></div>');s=r[0],i=r[1],e.has(s)||e.set(s,new Map),e.get(s).set(i,t)}}),e},l=t=>{const e=new Map;return t.getAttributeNames().filter(t=>r(t,["watch","action","toggle"])).forEach(a=>{e.set(a,t.getAttribute(a)),t.removeAttribute(a)}),e},u=(t,e,a,r,s)=>{e.forEach((e,i)=>{i=i.startsWith("on")?i.substring("on".length,i.length):i,t.addEventListener(i,t=>{"submit"===t.type&&(t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation());const i=a();let n=i.data._state;(e.has(n)||e.has("*"))&&r(a=>s(a,{type:e.get(n)||e.get("*"),data:i.data,event:t,key:i.key,index:i.index}))})})},p=(e,r,s,i)=>{const o=s.data,h=r.get(i)||r.get("*");a(h)||h.forEach((a,r)=>{const s=m(o,a);var i;if(i=r,n.indexOf(i)<0&&e.setAttribute(r,s),r in e){e[r]=s;const i=t(r);e[i]=t=>g(o,a,t)}"content"===r&&(e.innerHTML=s)})},f=(t,a,r,s)=>{a.forEach((a,i)=>{const n=[],o=s.get(i),h=a.get(r);e(o)&&n.push(o),e(h)&&n.push(h);const d=n.join(" ");t.getAttribute(i)!==d&&t.setAttribute(i,d)})};const m=(t,e)=>{if(a(t))return t;try{return new Function("data",`return data.${e};`).call(null,t)}catch(e){console.warn(t,e.message)}return null},g=(t,e,r)=>{if(!a(t))try{return new Function("data","value",`data.${e} = value;`).call(null,t,r)}catch(t){console.warn(t.message)}};class b{constructor(t,e,a){this.render=t=>{this.dataGetter=t,this.attributeEvaluators.forEach(t=>t.render())},this.nodes=t,this.updateData=e,this.reducer=a;const r=["watch","action","toggle"],s=Array.from(y(r,this.nodes)),i=()=>this.dataGetter();this.attributeEvaluators=s.map(t=>new o(t,i,this.updateData,this.reducer))}}const y=(t,e)=>e.filter(i()).reduce((e,a)=>{if(!(a instanceof HTMLElement))return e;const s=a,i=s.getAttributeNames();for(const a of i)r(a,t)&&e.add(s);if(!r(s.tagName,["context-array".toUpperCase(),"context-element".toUpperCase()])){const a=y(t,Array.from(s.childNodes));Array.from(a).forEach(t=>e.add(t))}return e},new Set);class v extends HTMLElement{constructor(){super(),this.setData=t=>{this.dataSource=t(this.dataSource),this.render()},this.onMounted=t=>{this.onMountedCallback=t},this.updateDataCallback=e=>{this.setData(e);const a=t("data");a in this&&this[a].call(this,this.dataSource)},this.render=()=>{if(a(this.dataSource)||a(this.template))return;if(a(this.renderer)){const t=this.template.map(t=>t.cloneNode(!0));this.renderer=new b(t,this.updateDataCallback,this.reducer)}const t=[...this.renderer.nodes].reverse();let e=document.createElement("template");this.append(e);for(const a of t)e.previousSibling!==a&&this.insertBefore(a,e),e=a;const r=this.dataSource;this.renderer.render(()=>({data:r})),this.lastChild.remove()},this.initAttribute=()=>{},this.populateTemplate=()=>{this.template=Array.from(this.childNodes).filter(i()),this.innerHTML=""},this.template=null,this.renderer=null,this.reducer=null}get data(){return this.dataSource}set data(t){this.setData(()=>t)}connectedCallback(){if(this.initAttribute(),a(this.template)){this.classList.add("data-element-hidden");requestAnimationFrame(()=>{this.populateTemplate(),this.classList.remove("data-element-hidden"),this.render(),e(this.onMountedCallback)&&(this.onMountedCallback(),this.onMountedCallback=null)})}}}customElements.define("context-array",class extends v{constructor(){super(),this.setDataKeyPicker=t=>{this.dataKeyPicker=t},this.initAttribute=()=>{this.dataKeyField=this.getAttribute("data.key")},this.render=()=>{const t=this.dataSource,e=this.template,r=this.renderers;if(a(t)||a(e))return;this.removeExpiredData();let s=document.createElement("template");this.append(s);const i=t.length-1;[...t].reverse().forEach((t,a)=>{const n=this.dataKeyPicker(t);if(!r.has(n)){const t=e.map(t=>t.cloneNode(!0)),a=new b(t,this.updateDataCallback,this.reducer);r.set(n,a)}const o=r.get(n),h=[...o.nodes].reverse();for(const t of h)s.previousSibling!==t&&this.insertBefore(t,s),s=t;o.render(()=>({data:t,key:n,index:i-a}))}),this.lastChild.remove()},this.removeExpiredData=()=>{const t=this.renderers,e=this.dataSource.map(t=>this.dataKeyPicker(t));Array.from(t.keys()).filter(t=>e.indexOf(t)<0).forEach(e=>{t.get(e).nodes.forEach(t=>t.remove()),t.delete(e)})};this.renderers=new Map,this.dataKeyPicker=t=>{if(a(this.dataKeyField))throw new Error("'<context-array>' requires 'data.key' attribute. data-key value should refer to the unique attribute of the data.");return t[this.dataKeyField]}}static get observedAttributes(){return["data.key"]}attributeChangedCallback(t,e,a){"data.key"===t&&(this.dataKeyField=a)}}),customElements.define("context-element",v)}();
