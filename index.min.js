!function(){"use strict";const t=t=>t+"Changed",e=t=>null!=t&&""!==t,s=t=>!e(t),a=(t,e)=>e.reduce((e,s)=>e||t.indexOf(s)>=0,!1),n=document.createElement("style");function r(){return t=>t.nodeType!==Node.TEXT_NODE||/\S/.test(t.textContent)}n.innerHTML=".data-element-hidden {display: none !important;}",document.head.appendChild(n);const i=["data","reducer"];class o{constructor(t,e,s,a,n,r){this.stateAttributeProperty=null,this.attributeStateProperty=null,this.eventStateAction=null,this.render=()=>{const t=this.activeNode,e=this.stateAttributeProperty,s=this.attributeStateProperty,a=this.dataGetter().data,n=a._state,r=this.defaultAttributeValue,i=this.assetGetter;f(t,e,a,n,i),m(t,s,n,r)},this.activeNode=t,this.dataGetter=s,this.assetGetter=e,this.updateData=a,this.reducer=n,this.activeAttributeValue=d(t,r),this.defaultAttributeValue=function(t){const e=new Map;return t.getAttributeNames().forEach(s=>{e.set(s,t.getAttribute(s))}),e}(t),this.eventStateAction=h(this.activeAttributeValue),this.stateAttributeProperty=c(this.activeAttributeValue,["watch","asset"]),this.attributeStateProperty=l(this.activeAttributeValue,"toggle"),u(t,this.eventStateAction,s,a,n)}}const h=t=>{const e=new Map;return t.forEach((t,s)=>{if(s.endsWith("action")){const a=s.split(".");let n="",r="";1===a.length?(n="click",r="*"):2===a.length?(n=a[0],r="*"):a.length>2&&(n=a[0],r=a[1]),e.has(n)||e.set(n,new Map),e.get(n).set(r,t)}}),e},c=(t,e)=>{const s=new Map;return t.forEach((t,a)=>{if(e.filter(t=>a.endsWith(t)).length>0){const e=a.split(".");let n="",r="",i="";1===e.length?(n="content",r="*",i=e[0]):2===e.length?(n=e[0],r="*",i=e[1]):e.length>2&&(n=e[0],r=e[1],i=e[2]),s.has(r)||s.set(r,new Map);const o=s.get(r);o.has(n)||o.set(n,new Map),o.get(n).set(i,t)}}),s},l=(t,e)=>{const s=new Map;return t.forEach((t,a)=>{if(a.endsWith(e)){const e=a.split(".");let n="",r="";if(3!==e.length)throw new Error('toggle require 3 parameters separated with dot(.) : \' eg <div class="my-div" class.disabled.toggle="disabledCss"></div>');n=e[0],r=e[1],s.has(n)||s.set(n,new Map),s.get(n).set(r,t)}}),s},d=(t,e)=>{const s=new Map;return t.getAttributeNames().filter(t=>a(t,e)).forEach(e=>{s.set(e,t.getAttribute(e)),t.removeAttribute(e)}),s},u=(t,e,s,a,n)=>{e.forEach((e,r)=>{r=r.startsWith("on")?r.substring("on".length,r.length):r,t.addEventListener(r,t=>{"submit"===t.type&&(t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation());const r=s();let i=r.data._state;(e.has(i)||e.has("*"))&&a(s=>{const a=e.get(i)||e.get("*");let o=r.data;if("key"in r){const e=r;return o=e.data,n()(s,{type:a,event:t,data:o,key:e.key,index:e.index})}return n()(s,{type:a,event:t})})})})};function p(e,s,a,n,r){var o;if(o=e,i.indexOf(o)<0&&s.setAttribute(e,a),e in s){s[e]=a;s[t(e)]=t=>b(n,r,t)}"content"===e&&(s.innerHTML=a)}const f=(t,a,n,r,i)=>{const o=a.get(r)||a.get("*");s(o)||o.forEach((s,a)=>{const r=s.get("watch"),o=s.get("asset");let h=null;e(r)?h=g(n,r):e(o)&&(h=i(o)),p(a,t,h,n,r)})},m=(t,s,a,n)=>{s.forEach((s,r)=>{const i=[],o=n.get(r),h=s.get(a);e(o)&&i.push(o),e(h)&&i.push(h);const c=i.join(" ");t.getAttribute(r)!==c&&t.setAttribute(r,c)})};const g=(t,e)=>{if(s(t))return t;try{return new Function("data",`return data.${e};`).call(null,t)}catch(e){console.warn(t,e.message)}return null},b=(t,e,a)=>{if(!s(t))try{return new Function("data","value",`data.${e} = value;`).call(null,t,a)}catch(t){console.warn(t.message)}};class y{constructor(t,e,s,a){this.render=t=>{this.dataGetter=t,this.attributeEvaluators.forEach(t=>t.render())},this.nodes=t,this.assetGetter=e,this.updateData=s,this.reducer=a;const n=["watch","action","toggle","asset"],r=Array.from(A(n,this.nodes)),i=()=>this.dataGetter();this.attributeEvaluators=r.map(t=>new o(t,e,i,this.updateData,this.reducer,n))}}const A=(t,e)=>e.filter(r()).reduce((e,s)=>{if(!(s instanceof HTMLElement))return e;const n=s,r=n.getAttributeNames();for(const s of r)a(s,t)&&e.add(n);if(!a(n.tagName,["context-array".toUpperCase(),"context-element".toUpperCase()])){const s=A(t,Array.from(n.childNodes));Array.from(s).forEach(t=>e.add(t))}return e},new Set);class v extends HTMLElement{constructor(){super(),this.setData=t=>{this.contextData=t(this.contextData),this.render()},this.onMounted=t=>{this.onMountedCallback=t},this.updateDataCallback=e=>{this.setData(e);const s=t("data");s in this&&this[s].call(this,this.contextData)},this.render=()=>{if(s(this.contextData)||s(this.template))return;if(s(this.renderer)){const t=this.template.map(t=>t.cloneNode(!0));this.renderer=new y(t,this.getAsset,this.updateDataCallback,()=>this.reducer)}const t=[...this.renderer.nodes].reverse();let e=document.createElement("template");this.append(e);for(const s of t)e.previousSibling!==s&&this.insertBefore(s,e),e=s;const a=this.contextData;this.renderer.render(()=>({data:a})),this.lastChild.remove()},this.initAttribute=()=>{},this.populateTemplate=()=>{this.template=Array.from(this.childNodes).filter(r()),this.innerHTML=""},this.getAsset=t=>{const s=this.assets;if(e(s)&&t in s)return s[t];const a=this.superContextElement;return e(a)?a.getAsset(t):null},this.getSuperContextElement=t=>t instanceof v?t:e(t.parentNode)?this.getSuperContextElement(t.parentNode):null,this.template=null,this.renderer=null,this.reducer=null,this.contextData={},this.assets={}}get data(){return this.contextData}set data(t){this.setData(()=>t)}connectedCallback(){if(this.superContextElement=this.getSuperContextElement(this.parentNode),this.initAttribute(),s(this.template)){this.classList.add("data-element-hidden");requestAnimationFrame(()=>{this.populateTemplate(),this.classList.remove("data-element-hidden"),this.render(),e(this.onMountedCallback)&&(this.onMountedCallback(),this.onMountedCallback=null)})}}disconnectedCallback(){this.superContextElement=null}}customElements.define("context-array",class extends v{constructor(){super(),this.setDataKeyPicker=t=>{this.dataKeyPicker=t},this.initAttribute=()=>{this.dataKeyField=this.getAttribute("data.key")},this.render=()=>{const t=this.contextData,e=this.template,a=this.renderers;if(s(t)||s(e))return;this.removeExpiredData();let n=document.createElement("template");this.append(n);const r=t.length-1;[...t].reverse().forEach((t,s)=>{const i=this.dataKeyPicker(t);if(!a.has(i)){const t=e.map(t=>t.cloneNode(!0)),s=new y(t,this.getAsset,this.updateDataCallback,()=>this.reducer);a.set(i,s)}const o=a.get(i),h=[...o.nodes].reverse();for(const t of h)n.previousSibling!==t&&this.insertBefore(t,n),n=t;o.render(()=>({data:t,key:i,index:r-s}))}),this.lastChild.remove()},this.removeExpiredData=()=>{const t=this.renderers,e=this.contextData.map(t=>this.dataKeyPicker(t));Array.from(t.keys()).filter(t=>e.indexOf(t)<0).forEach(e=>{t.get(e).nodes.forEach(t=>t.remove()),t.delete(e)})};this.renderers=new Map,this.dataKeyPicker=t=>{if(s(this.dataKeyField))throw new Error("'<context-array>' requires 'data.key' attribute. data-key value should refer to the unique attribute of the data.");return t[this.dataKeyField]},this.contextData=[]}static get observedAttributes(){return["data.key"]}attributeChangedCallback(t,e,s){"data.key"===t&&(this.dataKeyField=s)}}),customElements.define("context-element",v)}();
